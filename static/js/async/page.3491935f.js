"use strict";(self.webpackChunkbill_reconciliation=self.webpackChunkbill_reconciliation||[]).push([[768],{80149:(e,t,r)=>{r.r(t),r.d(t,{default:()=>X});var n=r(78613),i=r(52876),o=r(89787),a=r(19631),l=r(87363),c=r(5726),s=r.n(c);let d=function(e){return e[e.INCOME=0]="INCOME",e[e.EXPENSE=1]="EXPENSE",e[e.TRANSFER=2]="TRANSFER",e[e.BORROW_IN=3]="BORROW_IN",e[e.BORROW_OUT=4]="BORROW_OUT",e[e.PAYBACK_IN=5]="PAYBACK_IN",e[e.PAYBACK_OUT=6]="PAYBACK_OUT",e}({});function u(e){return new Promise((t=>{const r=document.createElement("input");r.style.display="none",r.type="file",r.accept=e||".json",r.acceptCharset="utf8",document.body.appendChild(r),r.addEventListener("change",(function e(){r.files&&r.files.length>0&&(r.removeEventListener("change",e),setTimeout((()=>r.remove()),500),t(r.files[0]))})),r.click()}))}function m(e,t="UTF-8"){return new Promise(((r,n)=>{const i=new FileReader;i.onerror=e=>n(e),i.onloadend=e=>{const t=e.target.result;r(t||"")},i.readAsText(e,t)}))}var f=r(98272);class p{constructor(){(0,f.Z)(this,"last",0),this.last=performance.now()}shouldIdle(){return performance.now()-this.last>16}sleep(){return new Promise((e=>{"undefined"!=typeof requestAnimationFrame?requestAnimationFrame((()=>{e(),this.last=performance.now()})):setTimeout((()=>{e(),this.last=performance.now()}),1)}))}}const h={\u6536\u5165:d.INCOME,\u652f\u51fa:d.EXPENSE,\u8f6c\u8d26:d.TRANSFER,\u8fd8\u6b3e:d.TRANSFER,"\u503a\u52a1-\u501f\u5165":d.BORROW_IN,"\u503a\u52a1-\u501f\u51fa":d.BORROW_OUT,"\u503a\u52a1-\u6536\u6b3e":d.PAYBACK_IN,"\u503a\u52a1-\u8fd8\u6b3e":d.PAYBACK_OUT},y={key:"qianji",name:"\u94b1\u8ff9",picker:()=>u("csv"),parser:(E=(0,n.Z)((function*(e){const t=new p,r=(yield m(e)).trim().split("\n");yield t.sleep();const n=r[0].split(","),i=e=>{const t=n.indexOf(e);if(-1===t)throw new Error(`\u672a\u627e\u5230 ${e} \u5217\uff0c\u8bf7\u68c0\u67e5\u6570\u636e`);return t},o=i("DataId"),a=i("\u7c7b\u578b"),l=i("\u91d1\u989d"),c=i("\u8d26\u62371"),d=i("\u8d26\u62372"),u=i("\u65f6\u95f4"),f=i("\u5206\u7c7b"),y=i("\u5907\u6ce8"),E=[];for(let m=1;m<r.length;m++){t.shouldIdle()&&(yield t.sleep());const e=r[m].split(",");E.push({id:e[o],type:h[e[a]],money:e[l],account1:e[c],account2:e[d],time:s()(e[u]).unix(),category:e[f],remark:e[y]})}return E.sort(((e,t)=>t.time-e.time))})),function(e){return E.apply(this,arguments)})};var E,N=y,g=r(9253);const x={key:"bang-cgb",name:"\u5e7f\u53d1\u94f6\u884c",picker:()=>u("csv"),parser:function(){var e=(0,n.Z)((function*(e,t){const r=new p,n=(yield m(e,"GB2312")).trim().split("\n");yield r.sleep();const i=n[0].split(","),o=e=>{const t=i.indexOf(e);if(-1===t)throw new Error(`\u672a\u627e\u5230 ${e} \u5217\uff0c\u8bf7\u68c0\u67e5\u6570\u636e`);return t},a=o("\u5165\u8d26\u91d1\u989d"),l=o("\u4ea4\u6613\u65e5"),c=o("\u4ea4\u6613\u6458\u8981"),u=[];for(let m=1;m<n.length;m++){r.shouldIdle()&&(yield r.sleep());const e=n[m].split(","),i=Number(e[a].trim());u.push({id:`cgb-${e[l].trim()}-${(0,g.x0)()}`,account:t,type:i>0?d.EXPENSE:d.INCOME,money:e[a].trim().replace(/^-/,"").replace("\uff08\u5f85\u5165\u8d26\uff09",""),time:s()(e[l].trim()).unix(),remark:e[c].trim()})}return u.sort(((e,t)=>t.time-e.time))}));return function(t,r){return e.apply(this,arguments)}}()};const A=[N],b=[x];function w(e,t,r=0){for(let n=r;n<e.length&&n>=0;n++)if(t(e[n]))return n;return-1}const I={[d.INCOME]:"\u6536\u5165",[d.EXPENSE]:"\u652f\u51fa",[d.TRANSFER]:"\u8f6c\u8d26/\u8fd8\u6b3e",[d.BORROW_IN]:"\u503a\u52a1-\u501f\u5165",[d.BORROW_OUT]:"\u503a\u52a1-\u501f\u51fa",[d.PAYBACK_IN]:"\u503a\u52a1-\u6536\u6b3e",[d.PAYBACK_OUT]:"\u503a\u52a1-\u8fd8\u6b3e"},O=5,R=1,S=1e4;function C(){return C=(0,n.Z)((function*(e,t){const r=[],n=new p;for(let i=0;i<t.length;i++){n.shouldIdle()&&(yield n.sleep());const o=t[i];let a="";e.includes(o.account1)&&(a=o.account1),e.includes(o.account2)&&(a=o.account2),a&&(o.type!==d.INCOME&&o.type!==d.EXPENSE?r.push({id:o.id,type:o.account1===a?d.EXPENSE:d.INCOME,account:a,time:o.time,money:o.money,remark:`${I[o.type]}-${o.category}-${o.remark}`}):r.push({id:o.id,account:a,type:o.type,time:o.time,money:o.money,remark:`${o.category}-${o.remark}`}))}return r})),C.apply(this,arguments)}function j(e,t){if(e.type!==t.type)return Number.MAX_SAFE_INTEGER;const r=Math.abs(Number(e.money)-Number(t.money))*O,n=Math.abs(e.time-t.time)*R;if(Number.isNaN(r)||Number.isNaN(n))return Number.MAX_SAFE_INTEGER;const i=r+n;return i>Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:i}const v=172800;function _(){return _=(0,n.Z)((function*(e,t){const r=new p,n=e.length>t.length,i=n?e:t,o=n?t:e;if(0===i.length||0===o.length)throw new Error("\u6570\u636e\u4e0d\u53ef\u4e3a\u7a7a");const a=[],l=new Set,c={start:0,end:0};for(let s=0;s<o.length;s++){r.shouldIdle()&&(yield r.sleep());const e=o[s];c.start=w(i,(t=>e.time<v+t.time),c.start),c.end=w(i,(t=>t.time<e.time-v),Math.max(c.start,c.end));const t=new Array(c.end-c.start+1).fill(null).map(((t,r)=>{const n=i[c.start+r],o=Number(n.money)===Number(e.money)&&Math.abs(n.time-e.time)<=120;return{score:j(n,e),fullMatch:o,record:n}})).sort(((e,t)=>e.fullMatch!==t.fullMatch?e.fullMatch?-1:1:e.score-t.score))[0];t&&t.score<=S?(l.add(t.record),a.push({id:`${t.record.id}_${e.id}`,score:t.score,time:t.record.time,[n?"bill":"record"]:t.record,[n?"record":"bill"]:e})):a.push({id:`~NONE~_${e.id}`,score:Number.MAX_SAFE_INTEGER,time:e.time,[n?"record":"bill"]:e})}for(const s of i)if(r.shouldIdle()&&(yield r.sleep()),!l.has(s)){l.add(s);const e=w(a,(e=>e.time<s.time));a.splice(e,0,{id:`${s.id}_~NONE~`,score:Number.MAX_SAFE_INTEGER,time:s.time,[n?"bill":"record"]:s})}return a})),_.apply(this,arguments)}const k=()=>{const e=(0,l.useRef)(),t=(0,l.useCallback)((t=>e.current=t),[]),[r,c]=(0,l.useState)([]),s=(0,l.useCallback)(((e,t)=>{c((r=>{const n=[...r];return n[e]=t,n}))}),[]),{data:d,loading:u,run:m}=(0,a.Z)(((e,t)=>t.parser(e)),{manual:!0,onSuccess:()=>{var t;const r=null===(t=e.current)||void 0===t?void 0:t.getValue("record");if(Array.isArray(r)){var n;const t={};r.forEach(((e,r)=>t[`record[${r}].account`]="")),null===(n=e.current)||void 0===n||n.setValues(t)}}}),[f,p]=(0,l.useMemo)((()=>{const e=new Set,t=new Set;d&&d.forEach((r=>{r.account1&&e.add(r.account1),r.account2&&e.add(r.account2),r.category&&t.add(r.category)}));return[Array.from(e).map((e=>({label:e,value:e}))),Array.from(t).map((e=>({label:e,value:e})))]}),[d]),h=(0,l.useCallback)(((e,t)=>{const r=Object.keys(t).filter((e=>e.endsWith(".account")||e.endsWith(".type")||e.endsWith(".file"))).map((e=>e.match(/record\[(\d+)\]/))).filter((e=>Boolean(e))).map((e=>Number(e[1])));(0,o.Z)(r).forEach((t=>{const{file:r,account:n,type:i}=e.record[t],o=b.find((e=>e.key===i));r&&n&&i&&o?(s(t,"loading"),o.parser(r,n).then((e=>s(t,e))).catch((e=>s(t,e)))):s(t,null)}))}),[]),{data:y,loading:E,run:N}=(0,a.Z)((0,n.Z)((function*(){var t;if(console.log("doDiff",d,r),!d)throw new Error("\u6ca1\u6709\u8bb0\u8d26\u6570\u636e");const n=r.filter((e=>Array.isArray(e)&&e.length>0));if(!d||0===n.length)throw new Error("\u6ca1\u6709\u5bf9\u6bd4\u8d26\u5355");const i=null===(t=e.current)||void 0===t?void 0:t.getValue("record").map((e=>e.account)),o=yield function(e,t){return C.apply(this,arguments)}(i,d);console.log("prepareBillRecord",o);const a=n.reduce(((e,t)=>[...e,...t]),[]).sort(((e,t)=>t.time-e.time)),l=yield function(e,t){return _.apply(this,arguments)}(o,a);return console.log("billDiff",l),l})),{manual:!0,onError:e=>i.Toast.error(e.message)});return{onGetFormApi:t,formOnChange:h,recordStatus:r,setRecordStatus:s,billData:d,loadingBillData:u,parseBillData:m,diffData:y,loadingDiffData:E,doDiff:N,account:f,category:p}},T=(0,l.createContext)({}),B=()=>(0,l.useContext)(T);var M=r(11527);var D=()=>{const{billData:e,loadingBillData:t,parseBillData:r}=B();return(0,M.jsx)(i.Card,{title:(0,M.jsxs)(i.Space,{children:[(0,M.jsxs)(i.Tag,{color:e?"green":"red",children:[e?"\u5df2":"\u672a","\u9009\u62e9"]}),(0,M.jsx)("span",{children:"\u7b2c\u4e00\u6b65\uff1a\u9009\u62e9\u8bb0\u8d26\u8f6f\u4ef6"})]}),children:(0,M.jsx)(i.Spin,{spinning:t,children:(0,M.jsx)(i.Space,{children:A.map((e=>(0,M.jsx)(i.Button,{onClick:(0,n.Z)((function*(){const t=yield e.picker();r(t,e)})),children:e.name},e.key)))})})})},F=r(93914);const Y=({field:e})=>{const t=(0,i.useFieldApi)(e),{value:r={}}=(0,i.useFieldState)(e),{file:n}=r;return(0,M.jsx)(i.Dropdown,{showArrow:!0,menu:b.map((e=>({node:"item",name:e.name,onClick:()=>{e.picker().then((r=>{t.setValue((0,F.Z)((0,F.Z)({},t.getValue()||{}),{},{file:r,type:e.key}))})).catch((()=>{}))}}))),children:(0,M.jsx)(i.Button,{style:{width:"300px"},children:n?`\u5df2\u9009\u62e9\uff1a${n.name}`:"\u9009\u62e9\u6587\u4ef6"})})};var P=()=>{const{recordStatus:e,onGetFormApi:t,formOnChange:r,account:n}=B();return(0,M.jsx)(i.Card,{title:"\u7b2c\u4e8c\u6b65\uff1a\u9009\u62e9\u8d26\u5355\uff08\u53ef\u591a\u9009\uff09",children:(0,M.jsx)(i.Form,{onValueChange:r,getFormApi:t,children:(0,M.jsx)(i.ArrayField,{field:"record",initValue:[{}],children:({arrayFields:t,addWithInitValue:r})=>(0,M.jsxs)(i.Space,{vertical:!0,align:"start",style:{width:"100%"},children:[t.map((({field:t,key:r,remove:o},a)=>{return(0,M.jsxs)(i.Space,{children:[(0,M.jsx)("div",{style:{width:"60px"},children:(l=e[a],"loading"===l?(0,M.jsx)(i.Spin,{}):"object"==typeof l&&l instanceof Error?(0,M.jsx)(i.Tooltip,{content:l.message,children:(0,M.jsx)(i.Tag,{color:"red",children:"\u9519\u8bef"})}):Array.isArray(l)?(0,M.jsx)(i.Tag,{color:"green",children:"\u89e3\u6790\u6210\u529f"}):(0,M.jsx)(i.Tag,{color:"grey",children:"\u672a\u9009\u62e9"}))}),(0,M.jsx)(Y,{field:t}),(0,M.jsx)(i.Form.Select,{style:{width:"300px"},noLabel:!0,field:`${t}.account`,optionList:n}),(0,M.jsx)(i.Button,{onClick:o,children:"\u79fb\u9664"})]},r);var l})),(0,M.jsx)(i.Button,{onClick:()=>r({}),children:"\u6dfb\u52a0\u66f4\u591a"})]})})})})};var $=()=>{const{billData:e,loadingDiffData:t,diffData:r,doDiff:n}=B(),[o,a]=(0,l.useState)([]);return(0,M.jsxs)(i.Card,{title:"\u67e5\u770b\u7ed3\u679c",children:[(0,M.jsx)(i.Button,{onClick:n,children:"\u8ba1\u7b97\u7ed3\u679c"}),(0,M.jsx)(i.Table,{className:"diff-table",rowKey:"id",loading:t,size:"small",dataSource:r,rowSelection:{selectedRowKeys:o,onChange:e=>a(e)},virtualized:!0,columns:[{title:"\u65f6\u95f4",dataIndex:"time",render:e=>s()(1e3*e).format("YYYY-MM-DD HH:mm:ss")},{title:"\u8bb0\u8d26-\u7c7b\u578b",dataIndex:"bill.type",render:(t,r)=>{if(!r.bill)return"";const n=null==e?void 0:e.find((e=>e.id===r.bill.id));return n?I[n.type]:""}},{title:"\u8bb0\u8d26-\u91d1\u989d",dataIndex:"bill.money"},{title:"\u8bb0\u8d26-\u65f6\u95f4",dataIndex:"bill.time",render:e=>e?s()(1e3*e).format("YYYY-MM-DD HH:mm:ss"):""},{title:"\u8bb0\u8d26-\u5907\u6ce8",dataIndex:"bill.remark"},{title:"\u8d26\u5355-\u7c7b\u578b",dataIndex:"record.type"},{title:"\u8d26\u5355-\u91d1\u989d",dataIndex:"record.money"},{title:"\u8d26\u5355-\u65f6\u95f4",dataIndex:"record.time",render:e=>e?s()(1e3*e).format("YYYY-MM-DD HH:mm:ss"):""},{title:"\u8d26\u5355-\u5907\u6ce8",dataIndex:"record.remark"}],pagination:!1,onRow:e=>null!=e&&e.bill?null!=e&&e.record?{}:{className:"diff-remove"}:{className:"diff-add"}})]})};var X=()=>{const e=k();return(0,M.jsxs)(T.Provider,{value:e,children:[(0,M.jsx)(D,{}),(0,M.jsx)(P,{}),(0,M.jsx)($,{})]})}}}]);